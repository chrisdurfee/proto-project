name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: PHP ${{ matrix.php }} - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        php: ['8.4']

    services:
      mariadb:
        image: mariadb:11.7
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: proto
          MYSQL_USER: proto_app_user
          MYSQL_PASSWORD: ProtoApp2025!SecureDbPass#789
        ports:
          - 3307:3306
        options: >-
          --health-cmd="healthcheck.sh --connect --innodb_initialized"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, pdo_mysql, bcmath, intl, gd, exif, iconv
          coverage: xdebug

      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Copy environment configuration
        run: cp common/Config/.env-example common/Config/.env

      - name: Wait for MariaDB
        run: |
          echo "Waiting for MariaDB to be fully ready..."
          for i in {1..30}; do
            if mysqladmin ping -h"127.0.0.1" -P"3307" -u"root" -p"root" --silent 2>/dev/null; then
              echo "✓ MariaDB is responding to ping"
              # Extra verification - can we actually connect?
              if mysql -h127.0.0.1 -P3307 -uroot -proot -e "SELECT 1" &>/dev/null; then
                echo "✓ MariaDB is accepting connections"
                break
              fi
            fi
            echo "  Waiting for MariaDB... ($i/30)"
            sleep 2
          done

          # Final check
          if ! mysql -h127.0.0.1 -P3307 -uroot -proot -e "SELECT 'Final check OK' as status"; then
            echo "ERROR: MariaDB is not ready after 60 seconds"
            exit 1
          fi

      - name: Update test database configuration
        run: |
          node <<'NODE'
          import fs from 'fs';

          const path = 'common/Config/.env';
          const config = JSON.parse(fs.readFileSync(path, 'utf8'));

          // Set environment to testing - CRITICAL for Proto to use testing connection
          config.env = 'testing';

          // Configure test database connection
          config.connections.default.testing = {
            username: 'root',
            password: 'root',
            host: '127.0.0.1',
            database: 'proto',
            port: 3307
          };

          // Disable cache for tests (avoid Redis connection issues)
          if (config.cache)
          {
            config.cache.driver = null;
            if (config.cache.connection)
            {
              delete config.cache.connection.password;
              config.cache.connection.host = '127.0.0.1';
              config.cache.connection.port = 6379;
            }
          }

          // Write updated config
          fs.writeFileSync(path, JSON.stringify(config, null, 4));
          console.log('✓ Updated testing database configuration');
          console.log('  Environment:', config.env);
          console.log('  Database config:', JSON.stringify(config.connections.default.testing, null, 2));
          NODE

      - name: Verify configuration file
        run: |
          echo "Checking .env file..."
          cat common/Config/.env | grep -A 8 '"testing"' || echo "Testing config not found in .env"

      - name: Verify database connection
        run: |
          echo "Testing database connection..."
          mysql -h127.0.0.1 -P3307 -uroot -proot -e "SELECT 'Database connection successful' as status; SHOW DATABASES;"
          mysql -h127.0.0.1 -P3307 -uroot -proot proto -e "SHOW TABLES;" || echo "No tables yet (OK before migrations)"

      - name: Test PHP database connection
        run: |
          php -r "
          \$mysqli = new mysqli('127.0.0.1', 'root', 'root', 'proto', 3307);
          if (\$mysqli->connect_error) {
            die('Connect Error: ' . \$mysqli->connect_error);
          }
          echo '✓ PHP MySQL connection successful' . PHP_EOL;
          \$mysqli->close();
          "

      - name: Test Proto framework database connection
        run: |
          php -r "
          require 'vendor/autoload.php';

          // Set testing environment BEFORE initializing Base
          \$_SERVER['APP_ENV'] = 'testing';
          \$_ENV['APP_ENV'] = 'testing';

          // Initialize Proto
          new Proto\Base();
          setEnv('env', 'testing');

          // Try to connect
          try {
            \$db = Proto\Database\Database::getConnection('default', true);
            if (\$db === null) {
              echo 'ERROR: getConnection returned null' . PHP_EOL;
              exit(1);
            }

            // Test query
            \$result = \$db->first('SELECT 1 as test');
            if (\$result && isset(\$result->test) && \$result->test == 1) {
              echo '✓ Proto framework database connection successful' . PHP_EOL;

              // Show which database we connected to
              \$dbInfo = \$db->first('SELECT DATABASE() as db, USER() as user');
              echo '  Connected to: ' . \$dbInfo->db . ' as ' . \$dbInfo->user . PHP_EOL;
            } else {
              echo 'ERROR: Test query failed' . PHP_EOL;
              exit(1);
            }
          } catch (Exception \$e) {
            echo 'ERROR: ' . \$e->getMessage() . PHP_EOL;
            echo 'Trace: ' . \$e->getTraceAsString() . PHP_EOL;
            exit(1);
          }
          "
        env:
          APP_ENV: testing

      - name: Run database migrations
        run: php infrastructure/scripts/run-migrations.php
        env:
          APP_ENV: testing

      - name: Verify migrations
        run: |
          echo "Checking migrated tables..."
          mysql -h127.0.0.1 -P3307 -uroot -proot proto -e "SHOW TABLES;"
          mysql -h127.0.0.1 -P3307 -uroot -proot proto -e "DESCRIBE permissions;" || echo "permissions table not found"

      - name: Run tests
        run: vendor/bin/phpunit --testdox
        env:
          APP_ENV: testing

      - name: Generate coverage report
        if: matrix.php == '8.4'
        run: vendor/bin/phpunit --coverage-clover coverage.xml

      - name: Upload coverage to Codecov
        if: matrix.php == '8.4'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: dom, curl, libxml, mbstring, zip
          coverage: none

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Run PHPStan
        run: vendor/bin/phpstan analyse --configuration=phpstan.neon --memory-limit=2G
        continue-on-error: true

      - name: Check PHP syntax
        run: |
          ERRORS=0
          for file in $(find . -type f -name "*.php" ! -path "./vendor/*"); do
            php -l "$file" > /dev/null 2>&1
            if [ $? -ne 0 ]; then
              echo "Syntax error in: $file"
              php -l "$file"
              ERRORS=1
            fi
          done
          if [ $ERRORS -eq 1 ]; then
            exit 1
          fi
          echo "No syntax errors found"

  frontend:
    name: Frontend - ${{ matrix.app }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        app: [main, crm, developer]
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSL stub files
        run: |
          mkdir -p infrastructure/docker/ssl
          # Create stub SSL files for build process
          touch infrastructure/docker/ssl/localhost.key
          touch infrastructure/docker/ssl/localhost.crt

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: apps/${{ matrix.app }}/package-lock.json

      - name: Install dependencies
        working-directory: apps/${{ matrix.app }}
        run: npm install

      - name: Type check
        working-directory: apps/${{ matrix.app }}
        run: npm run type-check
        continue-on-error: true

      - name: Build
        working-directory: apps/${{ matrix.app }}
        env:
          NODE_ENV: production
        run: npm run build

      - name: Upload build artifacts
        if: matrix.node-version == '20.x' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-build
          path: apps/${{ matrix.app }}/dist
          retention-days: 7

  docker:
    name: Docker Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSL stub files for Docker build
        run: |
          mkdir -p infrastructure/docker/ssl
          # Create stub SSL files for Docker build
          openssl req -x509 -newkey rsa:2048 -nodes -days 365 \
            -keyout infrastructure/docker/ssl/localhost.key \
            -out infrastructure/docker/ssl/localhost.crt \
            -subj "/C=US/ST=State/L=City/O=Organization/CN=localhost"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infrastructure/docker/Dockerfile
          push: false
          load: true
          tags: proto-project:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker run --rm proto-project:test php -v
          docker run --rm proto-project:test composer --version

  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          coverage: none

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Check for security vulnerabilities
        run: composer audit
        continue-on-error: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Audit frontend dependencies - Main
        working-directory: apps/main
        run: |
          npm install
          npm audit --audit-level=high
        continue-on-error: true

      - name: Audit frontend dependencies - CRM
        working-directory: apps/crm
        run: |
          npm install
          npm audit --audit-level=high
        continue-on-error: true

      - name: Audit frontend dependencies - Developer
        working-directory: apps/developer
        run: |
          npm install
          npm audit --audit-level=high
        continue-on-error: true
