# Environment File Organization

## Overview

This project uses **two separate configuration systems** that serve different purposes:

1. **Application Configuration** (`common/Config/.env`) - JSON format, master source of truth
2. **Infrastructure Configuration** (`infrastructure/.env`) - Docker environment variables, auto-generated

## File Locations

### Application Config (Manual)
```
common/Config/.env          # JSON config - Edit this file to change settings
common/Config/.env-example  # Template with all available options
```

**Purpose**: Application-level configuration for PHP, frontend apps, and business logic.  
**Format**: JSON  
**Edit**: YES - This is the master configuration file  
**Version Control**: Add to `.gitignore` (contains secrets)

### Infrastructure Config (Auto-Generated)
```
infrastructure/.env                      # Docker Compose variables - DO NOT EDIT
infrastructure/.env.example              # Template for development
infrastructure/.env.production.example   # Template for production
```

**Purpose**: Docker Compose environment variables (database, redis, ports, etc.)  
**Format**: Shell variables (KEY=value)  
**Edit**: NO - Auto-generated by sync-config.js  
**Version Control**: Add to `.gitignore` (auto-generated + secrets)

## Configuration Flow

```
┌─────────────────────────┐
│  common/Config/.env     │  ← YOU EDIT THIS (JSON)
│  (Master Config)        │
└───────────┬─────────────┘
            │
            ▼
    sync-config.js reads JSON
            │
            ▼
┌─────────────────────────┐
│  infrastructure/.env    │  ← AUTO-GENERATED
│  (Docker Variables)     │
└───────────┬─────────────┘
            │
            ▼
    Docker Compose reads variables
            │
            ▼
┌─────────────────────────┐
│  Running Containers     │
└─────────────────────────┘
```

## Sync Configuration

### When to Sync

Run the sync command whenever you:
- Change database credentials
- Update Redis password
- Modify domain configuration
- Change SMTP settings
- Update any Docker-related config

### How to Sync

```bash
# From project root
./infrastructure/scripts/run.sh sync-config

# Or directly
node infrastructure/scripts/sync-config.js
```

### What Gets Synced

The sync process reads `common/Config/.env` (JSON) and generates `infrastructure/.env` with:

```env
# Database
DB_ROOT_PASSWORD=xxxxx
DB_USERNAME=proto_app_user
DB_PASSWORD=xxxxx
DB_DATABASE=proto

# Redis
REDIS_PASSWORD=xxxxx

# Ports
MYSQL_PORT=3307
REDIS_PORT=6380
API_PORT=8080
API_PORT_SSL=8443

# Domain & URLs
DOMAIN=yourdomain.com
SITE_URL=https://yourdomain.com

# SMTP (for Docker)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=xxxxx

# Environment
APP_ENV=development
AUTO_MIGRATE=true
```

## Docker Compose Integration

Docker Compose automatically reads `.env` files from the **same directory** as the compose file.

### Development
```bash
cd /home/tech-e/projects/proto-project

# Docker Compose looks for infrastructure/.env (same directory as compose file)
docker-compose -f infrastructure/docker-compose.yaml up -d
```

### Production
```bash
# Same behavior - reads infrastructure/.env
docker-compose -f infrastructure/docker-compose.production.yaml up -d
```

**Note**: No `env_file` directive needed - Docker Compose's default behavior handles it automatically.

## Setup Instructions

### First-Time Setup

1. **Copy application config template**:
   ```bash
   cp common/Config/.env-example common/Config/.env
   ```

2. **Edit application config** (JSON format):
   ```bash
   nano common/Config/.env
   ```
   Update: database passwords, Redis password, domain, SMTP settings

3. **Generate infrastructure config**:
   ```bash
   ./infrastructure/scripts/run.sh sync-config
   ```

4. **Verify generated file**:
   ```bash
   cat infrastructure/.env
   ```

5. **Start Docker services**:
   ```bash
   docker-compose -f infrastructure/docker-compose.yaml up -d
   ```

### Production Setup

1. **Use production template** (optional):
   ```bash
   # Review production template first
   cat infrastructure/.env.production.example
   
   # Can copy if you want to start from it
   cp infrastructure/.env.production.example infrastructure/.env
   ```

2. **Edit master config**:
   ```bash
   nano common/Config/.env
   ```
   Set production values: strong passwords, production domain, real SMTP

3. **Sync configuration**:
   ```bash
   ./infrastructure/scripts/run.sh sync-config
   ```

4. **Build and deploy**:
   ```bash
   docker build -f infrastructure/docker/Dockerfile -t proto-project-web:latest .
   docker-compose -f infrastructure/docker-compose.production.yaml up -d
   ```

## Version Control

### .gitignore Rules

```gitignore
# Application config (contains secrets)
common/Config/.env

# Infrastructure config (auto-generated + secrets)
infrastructure/.env
.env

# Keep templates
!common/Config/.env-example
!infrastructure/.env.example
!infrastructure/.env.production.example
```

### What to Commit

✅ **DO commit**:
- `common/Config/.env-example` (template)
- `infrastructure/.env.example` (development template)
- `infrastructure/.env.production.example` (production template)
- `infrastructure/scripts/sync-config.js` (generator script)

❌ **DON'T commit**:
- `common/Config/.env` (has real secrets)
- `infrastructure/.env` (has real secrets + auto-generated)
- Any `.env` file with actual credentials

## Troubleshooting

### "Please set DB_ROOT_PASSWORD in infrastructure/.env file"

**Problem**: Docker Compose can't find environment variables

**Solution**:
```bash
# 1. Check if infrastructure/.env exists
ls -la infrastructure/.env

# 2. If missing, generate it
./infrastructure/scripts/run.sh sync-config

# 3. Verify it has values
grep DB_ROOT_PASSWORD infrastructure/.env

# 4. Try starting again
docker-compose -f infrastructure/docker-compose.yaml up -d
```

### "Configuration sync failed"

**Problem**: sync-config.js can't read common/Config/.env

**Solution**:
```bash
# 1. Check if application config exists
ls -la common/Config/.env

# 2. If missing, copy template
cp common/Config/.env-example common/Config/.env

# 3. Edit with your values
nano common/Config/.env

# 4. Sync again
./infrastructure/scripts/run.sh sync-config
```

### Docker Compose can't find .env

**Problem**: Working directory doesn't match compose file location

**Solution**:
```bash
# Always run from project root
cd /home/tech-e/projects/proto-project

# Use full path to compose file
docker-compose -f infrastructure/docker-compose.yaml up -d

# Docker Compose will look for infrastructure/.env automatically
```

### Changes not taking effect

**Problem**: Forgot to sync after editing common/Config/.env

**Solution**:
```bash
# 1. Edit master config
nano common/Config/.env

# 2. MUST sync to propagate to Docker
./infrastructure/scripts/run.sh sync-config

# 3. Restart containers
docker-compose -f infrastructure/docker-compose.yaml restart

# Or recreate if needed
docker-compose -f infrastructure/docker-compose.yaml up -d --force-recreate
```

## Security Best Practices

1. **Never commit actual .env files** - Only templates
2. **Use strong passwords** - Especially for production
3. **Rotate credentials regularly** - Update in common/Config/.env and re-sync
4. **Restrict file permissions**:
   ```bash
   chmod 600 common/Config/.env
   chmod 600 infrastructure/.env
   ```
5. **Use different credentials for dev/prod** - Never reuse production credentials in development
6. **Keep templates generic** - No real data in .env-example files

## Migration from Old Structure

If you have `.env` files in the project root from an older version:

```bash
# 1. Backup old root .env
cp .env .env.backup

# 2. Move to infrastructure/ if it's Docker config
mv .env infrastructure/.env

# 3. Or regenerate from master config
./infrastructure/scripts/run.sh sync-config

# 4. Verify everything works
docker-compose -f infrastructure/docker-compose.yaml config --services

# 5. Clean up old backup once verified
rm .env.backup
```

## Related Documentation

- [QUICK-START.md](../../QUICK-START.md) - Fast setup guide
- [PRODUCTION-DEPLOYMENT.md](./PRODUCTION-DEPLOYMENT.md) - Production deployment guide
- [FILE-REORGANIZATION.md](./FILE-REORGANIZATION.md) - Project structure changes
- [DOMAIN-CONFIGURATION.md](./DOMAIN-CONFIGURATION.md) - Domain and URL setup
- [EMAIL-CONFIGURATION.md](./EMAIL-CONFIGURATION.md) - SMTP and email setup

## Summary

**Key Takeaways**:
1. ✏️ Edit `common/Config/.env` (JSON) for all configuration changes
2. 🔄 Run `./infrastructure/scripts/run.sh sync-config` to propagate changes
3. 🚫 Never manually edit `infrastructure/.env` (auto-generated)
4. 🔒 Keep all `.env` files out of version control
5. 📋 Docker Compose reads `infrastructure/.env` automatically
6. 🎯 Two config systems serve different purposes - both are essential
