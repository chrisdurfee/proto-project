# MariaDB Performance & Security Configuration
# Optimized for high concurrency and production security
# Mounted read-only into container

[mysqld]
# ===========================================
# INNODB BUFFER POOL - SCALABILITY
# ===========================================
# Adjust buffer pool to ~70% of container memory in production
# For 4GB container = 2.8GB, for 8GB = 5.6GB
innodb_buffer_pool_size=2G
innodb_buffer_pool_instances=4
innodb_buffer_pool_chunk_size=128M
innodb_log_file_size=512M
innodb_log_buffer_size=64M
innodb_flush_method=O_DIRECT
innodb_flush_log_at_trx_commit=1
innodb_file_per_table=1
innodb_doublewrite=1

# INNODB I/O PERFORMANCE
innodb_io_capacity=2000
innodb_io_capacity_max=4000
innodb_read_io_threads=8
innodb_write_io_threads=8

# ===========================================
# CONNECTIONS & THREADS - HIGH CONCURRENCY
# ===========================================
max_connections=2000
thread_cache_size=512
thread_handling=pool-of-threads
thread_pool_size=32
thread_pool_max_threads=500
table_open_cache=8000
table_open_cache_instances=16
table_definition_cache=4000

# Connection limits per user (security)
max_user_connections=100

# ===========================================
# QUERY OPTIMIZATION
# ===========================================
# Query Cache is deprecated - keep disabled
query_cache_type=0
query_cache_size=0

# Join and sort buffers
join_buffer_size=4M
sort_buffer_size=4M
read_buffer_size=2M
read_rnd_buffer_size=4M

# Temporary tables
tmp_table_size=256M
max_heap_table_size=256M

# ===========================================
# LOGGING & MONITORING
# ===========================================
slow_query_log=1
slow_query_log_file=/var/lib/mysql/slow.log
long_query_time=1
log_queries_not_using_indexes=1
log_slow_admin_statements=1
log_error=/var/lib/mysql/error.log

# General query log (DISABLE in production - only for debugging)
general_log=0

# ===========================================
# SECURITY SETTINGS
# ===========================================
# Bind to all interfaces within Docker network
bind-address=0.0.0.0

# Disable symbolic links
symbolic-links=0

# Disable local file loading
local_infile=0

# Secure file operations
secure_file_priv=/var/lib/mysql-files

# Skip name resolution for faster connections
skip_name_resolve=1

# Password policy (if validate_password plugin installed)
# plugin-load-add=simple_password_check.so

# ===========================================
# CHARACTER SET & ENCODING
# ===========================================
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci
character-set-client-handshake=FALSE

# ===========================================
# TIMEOUT SETTINGS
# ===========================================
# Balanced timeouts for connection pool efficiency
wait_timeout=300
interactive_timeout=300
net_read_timeout=30
net_write_timeout=60
connect_timeout=10

# ===========================================
# PACKET SIZE
# ===========================================
max_allowed_packet=256M

[mysqldump]
quick
quote-names
max_allowed_packet=256M
single-transaction

[mysql]
default-character-set=utf8mb4

[client]
default-character-set=utf8mb4
