<VirtualHost *:80>
    ServerName localhost
    ServerAlias proto-project.local
    DocumentRoot /var/www/html/public

    # Disable server signature for security
    ServerSignature Off

    <Directory /var/www/html/public>
        AllowOverride All
        Require all granted
        DirectoryIndex index.php index.html

        # Disable directory listing for security
        Options -Indexes

        # CRITICAL: Disable MMAP and Sendfile for SSE/streaming support
        # These cause Apache to buffer file contents in memory
        EnableMMAP Off
        EnableSendfile Off

        # Default character set
        AddDefaultCharset UTF-8

        # PHP-FPM Proxy for .php files
        <FilesMatch \.php$>
            SetHandler "proxy:fcgi://127.0.0.1:9000"
        </FilesMatch>

        # Special handling for SSE sync endpoints - bypass normal PHP-FPM proxy
        RewriteCond %{REQUEST_URI} sync$
        RewriteRule ^(.*)$ - [E=SSE_ENDPOINT:1]

        # Enable URL rewriting
        RewriteEngine On

        # Block unwanted HTTP methods (TRACE/TRACK)
        RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
        RewriteRule .* - [F]

        # Block unwanted user agents (e.g., libwww-perl)
        RewriteCond %{HTTP_USER_AGENT} libwww-perl.*
        RewriteRule .* - [F,L]

        # URL rewriting rules for your app
        # Redirect non-existent files/directories (that aren't in api, crm, developer, embed, files, or images dirs) to main index
        RewriteBase /
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !^/(api|crm|developer|embed|files|images)/
        RewriteRule ^(.*)$ /main/$1 [NC,L,QSA]
    </Directory>

    # Tune FastCGI streaming behaviour for all PHP requests
    ProxyIOBufferSize 1024

    # Deny access to sensitive files
    <FilesMatch "^(\.htaccess|\.gitignore|\.dockerignore|composer\.(json|lock)|package-lock\.json|Dockerfile.*|docker-compose.*|phpunit.*|application\.yaml|bitbucket-pipelines\.yml)$">
        Require all denied
    </FilesMatch>

    # Deny access to sensitive directories
    <IfModule mod_alias.c>
        RedirectMatch 403 ^/(vendor|\.git|infrastructure|modules|tests|node_modules)(/.*)?$
    </IfModule>

    # Enhanced security headers
    <IfModule mod_headers.c>
        # Remove potentially disclosing headers
        Header unset X-Powered-By
        Header unset Server

        # Prevent clickjacking (SAMEORIGIN for iframe compatibility)
        Header always set X-Frame-Options "SAMEORIGIN"

        # Enable XSS protection
        Header always set X-XSS-Protection "1; mode=block"

        # Prevent MIME-type sniffing
        Header always set X-Content-Type-Options "nosniff"

        # Set Referrer Policy
        Header always set Referrer-Policy "strict-origin-when-cross-origin"

        # For development - comment out HSTS in production
        # Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"

        # Content Security Policy (relaxed for development)
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src * data: blob:; font-src 'self' data:; connect-src 'self' ws: wss:; frame-ancestors 'self'; object-src 'none'; base-uri 'self'"

        # Set Permissions Policy (formerly Feature Policy)
        Header always set Permissions-Policy "geolocation=(self), microphone=(), camera=(), fullscreen=(self)"

        # Prevent cross-domain policy loading
        Header always set X-Permitted-Cross-Domain-Policies "none"

        # Ensure persistent connection
        Header set Connection keep-alive
    </IfModule>

    # Turn off ETags
    FileETag None

    # Add support for font files
    AddType application/font-woff2 .woff2
    AddType application/font-woff .woff
    AddType application/vnd.ms-fontobject .eot
    AddType font/truetype .ttf
    AddType font/opentype .otf

    # Logging
    ErrorLog /var/log/apache2/error.log
    CustomLog /var/log/apache2/access.log combined

    # Performance: Enable Keep-Alive
    KeepAlive On
    KeepAliveTimeout 5
    MaxKeepAliveRequests 100

    # Enhanced compression with mod_deflate
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain text/html text/css text/javascript application/javascript application/json application/xml application/xhtml+xml text/xml font/otf font/ttf font/eot application/font-woff application/font-woff2

        # Don't compress images and binaries
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png|ico|bmp|webp)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar|7z)$ no-gzip dont-vary
    </IfModule>

    # Enhanced compression with mod_brotli (if available)
    <IfModule mod_brotli.c>
        AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/css application/javascript application/json application/xml application/xhtml+xml text/xml image/svg+xml
    </IfModule>

    # Enhanced browser caching for static assets
    <IfModule mod_expires.c>
        ExpiresActive On

        # Images
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"
        ExpiresByType image/bmp "access plus 1 year"
        ExpiresByType image/x-icon "access plus 1 year"

        # Fonts
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/ttf "access plus 1 year"
        ExpiresByType font/otf "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/vnd.ms-fontobject "access plus 1 year"

        # CSS and JavaScript
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        ExpiresByType text/javascript "access plus 1 month"
        ExpiresByType application/x-javascript "access plus 1 month"

        # Default cache for other files
        ExpiresDefault "access plus 2 days"
    </IfModule>
</VirtualHost>